#=============================================================
# Lesson 5: 標準偏差(SD)と標準誤差(SE) ─ 何が違うの？
#=============================================================
#
# ■ 標準偏差（SD: Standard Deviation）
#   → 手元のサンプルデータが「どれくらいばらついているか」を表す
#   → 「このクラスの身長はどれくらいバラバラ？」
#
# ■ 標準誤差（SE: Standard Error）
#   → サンプルの平均値から「母集団の平均はこのへんだろう」と
#     推計するときの不確かさ（ブレ幅）を表す
#   → 「日本人全体の平均身長はだいたいこの範囲にあるはず」
#
# ■ 計算式:
#   SE = SD / √n   （n = サンプルサイズ）
#
# つまり SE は SD を √n で割ったもの。
# n > 1 なら √n > 1 なので、SE は必ず SD より小さくなる！
# さらにサンプルサイズ n を大きくすればするほど SE は小さくなる。
#=============================================================


#=============================================================
# 【準備】
#=============================================================

rm(list = ls())    # 環境中のすべての変数を削除して、まっさらな状態にする

library(tidyverse) # データ操作(dplyr)とグラフ(ggplot2)をまとめて読み込むパッケージ
library(ggthemes)  # ggplot2にきれいなテーマや配色パレットを追加するパッケージ

theme_set(theme_gray(         # ggplot2のデフォルトテーマを設定する
  base_family = "HiraginoSans-W3",  # フォントをヒラギノに指定（日本語の文字化け防止）
  base_size = 12              # 文字サイズの基本値を12ptに設定
))


#=============================================================
# 【STEP 1】 まずは具体例で理解しよう
#=============================================================
# 「日本人男性の平均身長は 171.7cm、標準偏差は 6.6cm」と言われている。
# ここからサンプル（標本）を取り出して実験してみよう。

set.seed(42)       # 乱数の種を42に固定する（これで何度実行しても同じ乱数が生成される）

# 母集団のパラメータ（本当の値。普通は知ることができない！）
pop_mean <- 171.7  # 母平均（日本人男性の本当の平均身長）を変数に入れる
pop_sd   <- 6.6    # 母標準偏差（日本人男性の本当の身長のばらつき）を変数に入れる

# 20人分のサンプルを取り出す
sample_20 <- rnorm(n = 20, mean = pop_mean, sd = pop_sd)
# rnorm(): 正規分布に従う乱数を生成する関数
#   n = 20       → 20個の乱数を作る（＝20人分のサンプル）
#   mean = 171.7 → 平均171.7cmを中心に
#   sd = 6.6     → 標準偏差6.6cmのばらつきで散らばる

# サンプルの中身を見てみよう
round(sample_20, 1)  # round()で小数点第1位に丸めて表示する

# サンプルの平均と標準偏差
mean(sample_20)   # sample_20の平均値を計算する ← 母平均（171.7）にだいたい近いはず
sd(sample_20)     # sample_20の標準偏差を計算する ← 母SD（6.6）にだいたい近いはず

# ★ 標準偏差（SD）＝このサンプル20人の身長が「どれくらいばらついているか」


#=============================================================
# 【STEP 2】 標準誤差を計算してみよう
#=============================================================

# 標準誤差（SE）= SD / √n
n <- length(sample_20)            # length()でsample_20の要素数（＝サンプルサイズ20）を取得
sample_sd <- sd(sample_20)        # sd()でsample_20の標準偏差を計算して変数に保存
sample_se <- sample_sd / sqrt(n)  # 標準偏差をサンプルサイズの平方根で割って標準誤差を計算
                                  # sqrt()は平方根（ルート）を計算する関数

cat("--- 20人のサンプル ---\n")                    # cat()で文字列をコンソールに出力する（\nは改行）
cat("サンプル平均  :", round(mean(sample_20), 2), "\n")  # 平均を小数点第2位で丸めて表示
cat("標準偏差 (SD) :", round(sample_sd, 2), "\n")        # SDを小数点第2位で丸めて表示
cat("標準誤差 (SE) :", round(sample_se, 2), "\n")        # SEを小数点第2位で丸めて表示

# ★ SE は SD より必ず小さい！
# 　 SD はサンプルの「ばらつき」
# 　 SE は平均値の「不確かさ」（母集団の平均がどこにありそうか）


#=============================================================
# 【STEP 3】 SD と SE の違いを図で見よう
#=============================================================

sample_mean <- mean(sample_20)  # サンプルの平均値を変数に保存しておく

# SD の範囲：平均 ± SD → サンプルのばらつきの範囲
# SE の範囲：平均 ± SE → 母平均がありそうな範囲

comparison <- data.frame(       # グラフ用のデータフレームを作成する
  type  = c("標準偏差 (SD)", "標準誤差 (SE)"),            # 2行分のラベル
  mean  = c(sample_mean, sample_mean),                    # どちらもサンプル平均を中心にする
  lower = c(sample_mean - sample_sd, sample_mean - sample_se),  # 下限 = 平均 - SD or SE
  upper = c(sample_mean + sample_sd, sample_mean + sample_se)   # 上限 = 平均 + SD or SE
)

ggplot(comparison, aes(x = type, y = mean, color = type)) +  # typeごとに色分けした散布図のベースを作成
  geom_point(size = 4) +                # 平均値の位置に点を描く（サイズ4）
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, linewidth = 1.2) +
  # geom_errorbar(): 縦方向のエラーバーを描く
  #   ymin = 下端の値、ymax = 上端の値
  #   width = エラーバーの横幅（ヒゲの長さ）
  #   linewidth = 線の太さ
  geom_hline(yintercept = pop_mean, linetype = "dashed", color = "red") +
  # geom_hline(): 水平線を引く
  #   yintercept = 線を引くy座標（母平均の位置）
  #   linetype = "dashed" で破線にする
  annotate("text", x = 2.4, y = pop_mean + 0.3, label = "母平均 (171.7)",
           color = "red", size = 4) +
  # annotate("text"): グラフ上の任意の位置にテキストを配置する
  #   x, y = テキストの位置、label = 表示する文字列
  scale_color_tableau() +       # ggthemesパッケージのTableau風の色パレットを適用
  labs(                         # グラフのラベルを設定する
    title = "標準偏差(SD) と 標準誤差(SE) の比較",   # タイトル
    subtitle = paste0("サンプルサイズ n = ", n),       # サブタイトル（paste0で文字列を結合）
    x = "", y = "身長 (cm)"    # x軸ラベル（空）、y軸ラベル
  ) +
  theme(legend.position = "none")  # 凡例を非表示にする（色分けの説明は不要）

# → SD の幅は広い（データ全体のばらつき）
# → SE の幅は狭い（平均値の推定精度）


#=============================================================
# 【課題1】 SD と SE を自分で計算してみよう
#=============================================================

# 課題1-1: 下のデータの平均・SD・SE を計算しよう
test_scores <- c(65, 72, 78, 80, 55, 90, 68, 75, 82, 70)
# c()で10個の数値をベクトルにまとめてtest_scoresに代入

# 平均
# ヒント: mean()

# 標準偏差
# ヒント: sd()

# サンプルサイズ
# ヒント: length()

# 標準誤差
# ヒント: sd() / sqrt(length())


# 課題1-2: SE は SD より小さくなった？ なぜそうなる？
# → SE = SD / √n で、√n > 1 だから、必ず SE < SD になる



#=============================================================
# 【STEP 4】 サンプルサイズを変えて比べてみよう
#=============================================================
# ここが一番大事！
# 同じ母集団から「20人」「100人」「1000人」を取り出したとき、
# SD と SE はどう変わるか？

set.seed(42)  # 乱数の種を再度固定（再現性のため）

# 3つのサンプルサイズで実験
sizes <- c(20, 100, 1000)   # 試したいサンプルサイズをベクトルにまとめる
results <- data.frame()      # 結果を入れる空のデータフレームを用意する

for (n in sizes) {           # sizesの各要素（20, 100, 1000）を順番にnに入れて繰り返す
  samp <- rnorm(n, mean = pop_mean, sd = pop_sd)  # n人分のサンプルを正規分布から生成
  results <- rbind(results, data.frame(  # rbind()で結果を1行ずつ下に追加していく
    n    = n,                # サンプルサイズ
    mean = mean(samp),       # そのサンプルの平均値
    SD   = sd(samp),         # そのサンプルの標準偏差
    SE   = sd(samp) / sqrt(n)  # 標準誤差 = SD / √n
  ))
}                            # forループの終わり

# 結果を表示
results$n_label <- paste0("n = ", results$n)  # 「n = 20」のような表示用ラベル列を追加
print(results)               # データフレームの内容をコンソールに表示

# ★ 注目ポイント：
# ・SD は n を大きくしても大きく変わらない（母SDの6.6前後に安定する）
# ・SE は n を大きくするとどんどん小さくなる（SE = SD/√n だから）
# ・SE は SD より必ず小さい


#=============================================================
# 【STEP 5】 サンプルサイズによる変化を図で見よう
#=============================================================

results_long <- results %>%   # resultsデータフレームを受け取って
  pivot_longer(cols = c(SD, SE), names_to = "type", values_to = "value")
# pivot_longer(): 横長データを縦長データに変換する
#   cols = c(SD, SE)   → SD列とSE列を縦に積み重ねる
#   names_to = "type"  → 元の列名（"SD"か"SE"）がtype列に入る
#   values_to = "value" → 元の値がvalue列に入る

# SD と SE の棒グラフを並べて比較
ggplot(results_long, aes(x = factor(n), y = value, fill = type)) +
# factor(n): nを数値ではなくカテゴリとして扱う（x軸に均等に並ぶ）
# fill = type: SD と SE で塗り分ける
  geom_col(position = "dodge", width = 0.6) +
  # geom_col(): 値をそのまま高さにした棒グラフを描く
  #   position = "dodge" → SDとSEの棒を横に並べて表示する
  #   width = 0.6 → 棒の幅
  scale_fill_manual(values = c("SD" = "#457B9D", "SE" = "#E63946"),
                    labels = c("SD" = "標準偏差 (SD)", "SE" = "標準誤差 (SE)")) +
  # scale_fill_manual(): 塗りつぶしの色を手動で指定する
  #   values = 色の指定（カラーコード）
  #   labels = 凡例に表示するラベル名
  labs(                         # グラフのラベルを設定
    title = "サンプルサイズと SD・SE の関係",
    x = "サンプルサイズ (n)",
    y = "値",
    fill = ""                   # 凡例のタイトルを空にする
  ) +
  theme(legend.position = "bottom")  # 凡例をグラフの下に配置する

# → SD はほぼ横ばい（母SDに収束する）
# → SE は n が大きくなるほど急速に小さくなる


#=============================================================
# 【STEP 6】 もっと細かく変化を見てみよう（シミュレーション）
#=============================================================
# n を 10 から 500 まで変えて、SD と SE がどう変わるか描いてみよう

set.seed(42)  # 乱数の種を固定

sim_results <- data.frame()  # シミュレーション結果を入れる空のデータフレーム

for (n in seq(10, 500, by = 10)) {  # seq()で10から500まで10刻みの数列を生成し、順番にnに入れる
  samp <- rnorm(n, mean = pop_mean, sd = pop_sd)  # n人分のサンプルを生成
  sim_results <- rbind(sim_results, data.frame(    # 結果を1行追加
    n  = n,                    # サンプルサイズ
    SD = sd(samp),             # そのサンプルの標準偏差
    SE = sd(samp) / sqrt(n)   # そのサンプルの標準誤差
  ))
}

sim_long <- sim_results %>%    # sim_resultsを受け取って
  pivot_longer(cols = c(SD, SE), names_to = "type", values_to = "value")
# SD列とSE列を縦に積み重ねて、type列（"SD"/"SE"）とvalue列に変換

ggplot(sim_long, aes(x = n, y = value, color = type)) +  # nをx軸、valueをy軸、typeで色分け
  geom_line(linewidth = 1) +     # 折れ線を描く（太さ1）
  geom_point(size = 1.5) +       # 各データ点に点を打つ（サイズ1.5）
  geom_hline(yintercept = pop_sd, linetype = "dashed", color = "gray40") +
  # 母SD（6.6）の位置に灰色の破線を引く（基準線として）
  annotate("text", x = 450, y = pop_sd + 0.4, label = "母SD = 6.6", color = "gray40") +
  # 基準線のそばに「母SD = 6.6」というラベルを配置
  scale_color_manual(values = c("SD" = "#457B9D", "SE" = "#E63946"),
                     labels = c("SD" = "標準偏差 (SD)", "SE" = "標準誤差 (SE)")) +
  # 線の色を手動指定（SD=青系、SE=赤系）、凡例のラベルも設定
  labs(
    title = "サンプルサイズを大きくすると SD と SE はどう変わる？",
    x = "サンプルサイズ (n)",
    y = "値",
    color = ""                # 凡例タイトルを空にする
  ) +
  theme(legend.position = "bottom")  # 凡例を下に配置

# ★ グラフから読み取れること：
# ・SD（青）は母SD（6.6）の周りで安定する → サンプルのばらつきは母集団と同じ
# ・SE（赤）は n が増えるにつれてどんどん0に近づく → 推定が正確になる
# ・SE は常に SD より下にある！


#=============================================================
# 【課題2】 サンプルサイズの効果を体験しよう
#=============================================================

# 課題2-1: 母平均50, 母SD=10 の母集団から、
#          n=30 のサンプルを取り出して平均・SD・SEを計算しよう
# ヒント: rnorm(n = 30, mean = 50, sd = 10)


# 課題2-2: 同じ母集団から n=300 のサンプルを取り出して平均・SD・SEを計算しよう


# 課題2-3: n=30 と n=300 で SD と SE はそれぞれどう変わった？
#          「SD はあまり変わらない」「SE は大幅に小さくなった」ことを確認しよう


# 課題2-4: n=300 のとき SE は SD の何分の1になっている？ 計算で確かめよう
# ヒント: SE = SD / √n なので、SE / SD = 1/√n
#         1 / sqrt(300) を計算してみよう



#=============================================================
# 【STEP 7】 なぜ SE は必ず SD より小さいのか？
#=============================================================
#
# SE = SD / √n   という式を見れば一目瞭然。
#
#   n = 4   → SE = SD / 2     （SDの半分）
#   n = 9   → SE = SD / 3     （SDの3分の1）
#   n = 25  → SE = SD / 5     （SDの5分の1）
#   n = 100 → SE = SD / 10    （SDの10分の1）
#   n = 400 → SE = SD / 20    （SDの20分の1）
#
# n が 1より大きければ √n > 1 なので、SD を √n で割った SE は必ず SD より小さい。
# n を4倍にすると SE は半分になる（√4 = 2 だから）。

# 実際に計算して確認
cat("\n--- SE = SD / √n の確認 ---\n")  # 見出しを表示
for (n in c(4, 9, 25, 100, 400)) {      # 5つのnについて順番に繰り返す
  cat(sprintf("n = %3d → SE = SD / %.0f （SDの%.0f分の1）\n",
              n, sqrt(n), sqrt(n)))
  # sprintf(): 書式を指定して文字列を作る関数
  #   %3d  → 整数を3桁幅で表示（右寄せ）
  #   %.0f → 小数点以下0桁（整数表示）の実数
  # sqrt(n) → nの平方根を計算
}


#=============================================================
# 【STEP 8】 エラーバーで SD と SE の違いを可視化
#=============================================================
# 実際の研究でよく見る「平均 ± エラーバー」のグラフ。
# エラーバーが SD なのか SE なのかで意味がまったく違う！

set.seed(42)  # 乱数の種を固定

# 男女それぞれ100人のサンプル
male   <- rnorm(100, mean = 171.7, sd = 6.6)  # 男性100人の身長データを生成
female <- rnorm(100, mean = 158.3, sd = 5.7)  # 女性100人の身長データを生成

# 集計
error_data <- data.frame(       # 集計結果をデータフレームにまとめる
  sex  = c("男性", "女性"),     # 性別のラベル
  mean = c(mean(male), mean(female)),          # 男女それぞれの平均値
  SD   = c(sd(male), sd(female)),              # 男女それぞれの標準偏差
  SE   = c(sd(male)/sqrt(100), sd(female)/sqrt(100))  # 男女それぞれの標準誤差（SD/√100）
)

print(error_data)  # 集計結果を表示

# --- SD エラーバー: サンプルのばらつきを示す ---
ggplot(error_data, aes(x = sex, y = mean, fill = sex)) +  # 性別をx軸、平均をy軸、性別で塗り分け
  geom_col(width = 0.5, alpha = 0.7) +       # 棒グラフを描く（幅0.5、透明度0.7）
  geom_errorbar(aes(ymin = mean - SD, ymax = mean + SD), width = 0.2, linewidth = 1) +
  # エラーバーを描く: 下端 = 平均-SD、上端 = 平均+SD
  scale_fill_tableau() +       # Tableau風の色パレットを適用
  labs(title = "平均 ± SD（サンプルのばらつき）",
       subtitle = "エラーバーが重なる → ばらつきが大きく分布が重複している",
       x = "", y = "身長 (cm)") +
  coord_cartesian(ylim = c(140, 185)) +  # y軸の表示範囲を140〜185に固定（データは切らない）
  theme(legend.position = "none")  # 凡例を非表示

# --- SE エラーバー: 母平均の推定精度を示す ---
ggplot(error_data, aes(x = sex, y = mean, fill = sex)) +  # 同じデータで2つ目のグラフ
  geom_col(width = 0.5, alpha = 0.7) +       # 棒グラフを描く
  geom_errorbar(aes(ymin = mean - SE, ymax = mean + SE), width = 0.2, linewidth = 1) +
  # エラーバーを描く: 下端 = 平均-SE、上端 = 平均+SE（SDよりずっと短い！）
  scale_fill_tableau() +       # Tableau風の色パレット
  labs(title = "平均 ± SE（母平均の推定精度）",
       subtitle = "エラーバーが重ならない → 母平均に明確な差がある可能性が高い",
       x = "", y = "身長 (cm)") +
  coord_cartesian(ylim = c(140, 185)) +  # y軸の表示範囲を揃える（SD版と比較しやすくするため）
  theme(legend.position = "none")  # 凡例を非表示

# ★ 同じデータなのに、SD と SE でエラーバーの幅がまったく違う！
# ★ 論文やレポートでは「このエラーバーは SD か SE か」を必ず書くこと！


#=============================================================
# 【課題3】 エラーバーを描いてみよう
#=============================================================

# 課題3-1: 下のデータで男女別の平均・SD・SEを計算しよう
set.seed(123)  # 乱数の種を固定
group_A <- rnorm(50, mean = 60, sd = 12)   # グループA: 平均60, SD12 の正規分布から50人分生成
group_B <- rnorm(50, mean = 65, sd = 12)   # グループB: 平均65, SD12 の正規分布から50人分生成

# ヒント: mean(), sd(), sd()/sqrt(50) をそれぞれ計算


# 課題3-2: data.frame を作って、SD のエラーバー付き棒グラフを描こう


# 課題3-3: 同じデータで SE のエラーバー付き棒グラフを描こう


# 課題3-4: SD と SE のグラフを見比べて、違いを説明してみよう



#=============================================================
# 【総合課題】 まとめ
#=============================================================

# 総合課題1: 母平均100, 母SD=15 の正規分布から
#   n = 10, 50, 200, 1000 のサンプルを取り出し、
#   それぞれの平均・SD・SE を data.frame にまとめて表示しよう


# 総合課題2: 上の結果を使って、以下のことを確認しよう
#   (a) SD は n が変わってもあまり変わらない（15前後に安定する）
#   (b) SE は n が大きくなるほど小さくなる
#   (c) SE は常に SD より小さい


# 総合課題3: 4つのサンプルサイズの SE を棒グラフにして、
#            「n を増やすと SE が小さくなる」ことを視覚的に示そう


#=============================================================
# 【まとめ】 標準偏差と標準誤差の違い
#=============================================================
#
# ┌──────────────┬──────────────────────────────────────────┐
# │              │ 標準偏差 (SD)    │ 標準誤差 (SE)          │
# ├──────────────┼──────────────────┼────────────────────────┤
# │ 何を表す？   │ サンプルのばらつき │ 母平均の推定の不確かさ │
# │ 計算式       │ sd()             │ sd() / √n              │
# │ nを増やすと？│ 母SDに近づき安定  │ どんどん小さくなる     │
# │ SD との関係  │ ─                │ 必ず SD より小さい     │
# │ グラフでは   │ データの散らばり  │ 平均値の精度           │
# │ 使う場面     │ 「データがどれくらい │ 「母集団の平均はこの  │
# │              │  バラバラか」を示す │  あたり」と示すとき   │
# └──────────────┴──────────────────┴────────────────────────┘
#
# ★ SE = SD / √n だから、n > 1 なら SE は必ず SD より小さい
# ★ サンプルサイズを大きくすると SE は小さくなる（推定が正確になる）
# ★ SD はサンプルサイズを大きくしても母SDに収束するだけで、0にはならない
#=============================================================
